<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ªù Caro Online - Auth & Lobby</title>

    <style>
        :root {
            --board-size: 5;
            --cell-size: 60px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background-color: #e8f0f8;
            color: #333;
        }

        h1 {
            color: #1a73e8;
            margin-bottom: 30px;
        }

        /* Styles chung cho c√°c kh·ªëi ch·ª©c nƒÉng */
        #auth-container, #lobby-container, #game-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 400px;
            margin-bottom: 20px;
        }

        /* Styles cho c√°c Input v√† Button */
        input[type="text"], input[type="password"] {
            padding: 10px;
            margin: 8px 0;
            width: 90%;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: background-color 0.3s;
        }

        #login-button, #join-button {
            background-color: #4285f4; /* Xanh Google */
            color: white;
        }
        #signup-button {
            background-color: #34a853; /* Xanh l√° Google */
            color: white;
        }
        #logout-button, #reset-button {
            background-color: #ea4335; /* ƒê·ªè Google */
            color: white;
        }

        #login-button:hover, #join-button:hover { background-color: #3367d6; }
        #signup-button:hover { background-color: #2e8b46; }
        #logout-button:hover, #reset-button:hover { background-color: #c53929; }

        /* Game Board Styles (Gi·ªØ nguy√™n) */
        #player-info {
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            color: #555;
            min-height: 1.3em;
        }

        #status {
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: bold;
            color: #d9534f;
            min-height: 1.5em; 
        }

        #board {
            display: grid;
            grid-template-columns: repeat(var(--board-size), var(--cell-size)); 
            grid-template-rows: repeat(var(--board-size), var(--cell-size));
            border: 3px solid #333;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2em; 
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #ccc;
            transition: background-color 0.2s;
            user-select: none;
        }

        .cell:hover {
            background-color: #f0f0f0;
        }

        /* Lo·∫°i b·ªè vi·ªÅn cho l∆∞·ªõi 5x5 */
        .cell:nth-child(5n) { border-right: none; }
        .cell:nth-child(n+21) { border-bottom: none; }
        .cell:nth-child(5n+1) { border-left: none; }
        .cell:nth-child(-n+5) { border-top: none; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>Game C·ªù Caro Online (5x5)</h1>
    
    <div id="auth-container" style="display: none;">
        <h2>ƒêƒÉng Nh·∫≠p / ƒêƒÉng K√Ω</h2>
        <input type="text" id="auth-username" placeholder="T√™n ƒëƒÉng nh·∫≠p" maxlength="15">
        <input type="password" id="auth-password" placeholder="M·∫≠t kh·∫©u" maxlength="15">
        
        <div style="margin-top: 15px;">
            <button id="login-button">ƒêƒÉng Nh·∫≠p</button>
            <button id="signup-button">ƒêƒÉng K√Ω</button>
        </div>
        <p id="auth-message" style="color: red; margin-top: 10px; min-height: 1.2em;"></p>
    </div>

    <div id="lobby-container" style="display: none;">
        <h2>T√¨m Ph√≤ng Ch∆°i</h2>
        <p id="logged-in-user" style="font-weight: bold; color: #4285f4;"></p>
        <input type="text" id="room-input" placeholder="Nh·∫≠p t√™n ph√≤ng" value="CaroRoom1">
        <div style="margin-top: 15px;">
            <button id="join-button">Tham Gia Ph√≤ng</button>
            <button id="logout-button">ƒêƒÉng Xu·∫•t</button>
        </div>
        <p id="lobby-message" style="color: red; margin-top: 10px; min-height: 1.2em;"></p>
    </div>

    <div id="game-container" style="display: none; flex-direction: column; align-items: center;"> 
        <div id="player-info"></div>
        <div id="status"></div>
        
        <div id="board">
            <div class="cell" data-index="0"></div><div class="cell" data-index="1"></div><div class="cell" data-index="2"></div><div class="cell" data-index="3"></div><div class="cell" data-index="4"></div>
            <div class="cell" data-index="5"></div><div class="cell" data-index="6"></div><div class="cell" data-index="7"></div><div class="cell" data-index="8"></div><div class="cell" data-index="9"></div>
            <div class="cell" data-index="10"></div><div class="cell" data-index="11"></div><div class="cell" data-index="12"></div><div class="cell" data-index="13"></div><div class="cell" data-index="14"></div>
            <div class="cell" data-index="15"></div><div class="cell" data-index="16"></div><div class="cell" data-index="17"></div><div class="cell" data-index="18"></div><div class="cell" data-index="19"></div>
            <div class="cell" data-index="20"></div><div class="cell" data-index="21"></div><div class="cell" data-index="22"></div><div class="cell" data-index="23"></div><div class="cell" data-index="24"></div>
        </div>

        <button id="reset-button">Ch∆°i L·∫°i</button>
    </div>

    <script>
        const socket = io(); 

        // Khai b√°o bi·∫øn tr·∫°ng th√°i
        let userToken = localStorage.getItem('caroToken'); // L·∫•y Token n·∫øu c√≥
        let myRole = null; 
        let currentRoomId = null;
        let myUsername = null; 

        // DOM elements
        const authContainer = document.getElementById('auth-container');
        const lobbyContainer = document.getElementById('lobby-container');
        const authUsernameInput = document.getElementById('auth-username');
        const authPasswordInput = document.getElementById('auth-password');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const authMessage = document.getElementById('auth-message');
        const loggedInUserDisplay = document.getElementById('logged-in-user');
        const logoutButton = document.getElementById('logout-button');
        const roomInput = document.getElementById('room-input');
        const joinButton = document.getElementById('join-button');
        const lobbyMessage = document.getElementById('lobby-message');
        const cells = document.querySelectorAll('.cell');
        const statusDisplay = document.getElementById('status');
        const playerInfoDisplay = document.getElementById('player-info');
        const resetButton = document.getElementById('reset-button');

        // H√†m chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i giao di·ªán
        const updateUI = (state) => {
            authContainer.style.display = 'none';
            lobbyContainer.style.display = 'none';
            gameContainer.style.display = 'none';

            if (state === 'AUTH') {
                authContainer.style.display = 'block';
                authMessage.textContent = '';
            } else if (state === 'LOBBY') {
                lobbyContainer.style.display = 'block';
                loggedInUserDisplay.innerHTML = `Ch√†o m·ª´ng, <b>${myUsername}</b>!`;
                lobbyMessage.textContent = '';
            } else if (state === 'GAME') {
                gameContainer.style.display = 'flex';
            }
        };

        // H√†m c·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi ch∆°i
        const updatePlayerInfo = (playerX, playerO) => {
            const infoX = playerX ? playerX.username : 'Ch·ªù ƒë·ªëi th·ªß X';
            const infoO = playerO ? playerO.username : 'Ch·ªù ƒë·ªëi th·ªß O';
            
            playerInfoDisplay.innerHTML = `B·∫°n: <b>${myUsername} (${myRole})</b> &nbsp;|&nbsp; X: ${infoX} &nbsp;|&nbsp; O: ${infoO}`;
        }

        // ------------------
        // 1. LOGIC X√ÅC TH·ª∞C (AUTH)
        // ------------------

        socket.on('connect', () => {
            if (userToken) {
                // N·∫øu c√≥ Token, y√™u c·∫ßu server x√°c th·ª±c l·∫°i
                socket.emit('authenticate', userToken);
            } else {
                updateUI('AUTH'); // M·ªü m√†n h√¨nh ƒëƒÉng nh·∫≠p n·∫øu kh√¥ng c√≥ token
            }
        });
        
        // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω
        const handleAuth = (type) => {
            const username = authUsernameInput.value.trim();
            const password = authPasswordInput.value.trim();

            if (!username || !password) {
                authMessage.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·ªß t√™n v√† m·∫≠t kh·∫©u.';
                return;
            }

            authMessage.textContent = type === 'login' ? 'ƒêang ƒëƒÉng nh·∫≠p...' : 'ƒêang ƒëƒÉng k√Ω...';
            
            socket.emit(type, { username, password });
        };

        loginButton.addEventListener('click', () => handleAuth('login'));
        signupButton.addEventListener('click', () => handleAuth('signup'));

        // Nh·∫≠n ph·∫£n h·ªìi x√°c th·ª±c t·ª´ Server
        socket.on('authSuccess', ({ username, token }) => {
            userToken = token;
            myUsername = username;
            localStorage.setItem('caroToken', token);
            updateUI('LOBBY'); // Chuy·ªÉn sang m√†n h√¨nh Lobby
        });

        socket.on('authError', (message) => {
            authMessage.textContent = message;
            userToken = null; 
            localStorage.removeItem('caroToken');
            updateUI('AUTH');
        });
        
        // X·ª≠ l√Ω ƒêƒÉng Xu·∫•t
        logoutButton.addEventListener('click', () => {
            userToken = null;
            myUsername = null;
            localStorage.removeItem('caroToken');
            myRole = null;
            currentRoomId = null;
            // ƒê·∫∑t l·∫°i giao di·ªán v·ªÅ tr·∫°ng th√°i AUTH
            updateUI('AUTH'); 
        });

        // ------------------
        // 2. LOGIC PH√íNG CH·ªú V√Ä GAME
        // ------------------

        joinButton.addEventListener('click', () => {
            const roomId = roomInput.value.trim();
            if (!roomId) {
                lobbyMessage.textContent = 'Vui l√≤ng nh·∫≠p t√™n ph√≤ng.';
                return;
            }
            
            lobbyMessage.textContent = 'ƒêang tham gia...';
            // G·ª≠i token, room ID v√† username l√™n Server ƒë·ªÉ tham gia game
            socket.emit('joinGame', { roomId, token: userToken, username: myUsername });
        });

        // Nh·∫≠n t√≠n hi·ªáu tham gia ph√≤ng th√†nh c√¥ng
        socket.on('joinSuccess', ({ roomId, role, playerX, playerO }) => {
            currentRoomId = roomId;
            myRole = role;
            updateUI('GAME'); // Chuy·ªÉn sang m√†n h√¨nh Game
            updatePlayerInfo(playerX, playerO);
            statusDisplay.textContent = 'ƒê√£ v√†o ph√≤ng. Vui l√≤ng ch·ªù ƒë·ªëi th·ªß.';
        });

        // Nh·∫≠n l·ªói t·ª´ Server (Lobby ho·∫∑c JoinGame)
        socket.on('lobbyError', (message) => {
            lobbyMessage.textContent = message;
        });
        
        // 4. Nh·∫≠n c·∫≠p nh·∫≠t b√†n c·ªù t·ª´ Server
        socket.on('updateBoard', ({ board, nextTurn, winner, draw, playerX, playerO }) => {
            // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi ch∆°i 
            updatePlayerInfo(playerX, playerO); 
            
            // C·∫≠p nh·∫≠t giao di·ªán b√†n c·ªù
            board.forEach((value, index) => {
                cells[index].textContent = value;
            });

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i l∆∞·ª£t ch∆°i
            if (winner) {
                // Gi·∫£ ƒë·ªãnh Server g·ª≠i username ho·∫∑c Client t·ª± t√¨m
                const winnerUsername = winner === 'X' && playerX ? playerX.username : (winner === 'O' && playerO ? playerO.username : winner);
                statusDisplay.textContent = `Ng∆∞·ªùi ch∆°i ${winnerUsername} ƒë√£ th·∫Øng! üéâ`;
            } else if (draw) {
                statusDisplay.textContent = `Tr√≤ ch∆°i h√≤a! ü§ù`;
            } else {
                statusDisplay.textContent = `L∆∞·ª£t c·ªßa Ng∆∞·ªùi ch∆°i ${nextTurn}`;
            }
        });
        
        // X·ª≠ l√Ω click (G·ª≠i n∆∞·ªõc ƒëi l√™n Server)
        const handleCellClick = (event) => {
            // Ki·ªÉm tra: ƒë√£ c√≥ vai tr√≤, t√™n ph√≤ng v√† token ch∆∞a
            if (!myRole || !currentRoomId || !userToken) return; 
            
            const clickedCellIndex = parseInt(event.target.getAttribute('data-index'));

            socket.emit('makeMove', { 
                index: clickedCellIndex, 
                role: myRole, 
                roomId: currentRoomId,
                token: userToken // G·ª≠i token l√™n server ƒë·ªÉ x√°c minh
            });
        };

        // X·ª≠ l√Ω n√∫t Ch∆°i L·∫°i
        resetButton.addEventListener('click', () => {
             if (currentRoomId) {
                socket.emit('resetGame', currentRoomId); 
             }
        });

        // Thi·∫øt l·∫≠p l·∫Øng nghe s·ª± ki·ªán click tr√™n c√°c √¥
        cells.forEach(cell => cell.addEventListener('click', handleCellClick));

    </script>
</body>
</html>
