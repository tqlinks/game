<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ªù Caro Online (5x5) - Ph√≤ng Ch·ªù</title>

    <style>
        :root {
            --board-size: 5;
            --cell-size: 60px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background-color: #e8f0f8;
            color: #333;
        }

        h1 {
            color: #1a73e8;
            margin-bottom: 30px;
        }

        /* Styles cho M√ÄN H√åNH CH·ªú (LOBBY) */
        #lobby {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #lobby h2 {
            color: #333;
            margin-bottom: 20px;
        }

        #lobby input {
            padding: 10px;
            margin: 8px 0;
            width: 90%;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        #join-button {
            background-color: #4285f4;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: background-color 0.3s;
        }

        #join-button:hover {
            background-color: #3367d6;
        }

        /* Styles cho GAME */
        #player-info {
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            color: #555;
            min-height: 1.3em;
        }

        #status {
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: bold;
            color: #d9534f;
            min-height: 1.5em; 
        }

        #board {
            display: grid;
            grid-template-columns: repeat(var(--board-size), var(--cell-size)); 
            grid-template-rows: repeat(var(--board-size), var(--cell-size));
            border: 3px solid #333;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2em; 
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #ccc;
            transition: background-color 0.2s;
            user-select: none;
        }

        .cell:hover {
            background-color: #f0f0f0;
        }

        /* Lo·∫°i b·ªè vi·ªÅn cho l∆∞·ªõi N x N */
        .cell:nth-child(5n) { border-right: none; }
        .cell:nth-child(n+21) { border-bottom: none; }
        .cell:nth-child(5n+1) { border-left: none; }
        .cell:nth-child(-n+5) { border-top: none; }

        #reset-button {
            margin-top: 30px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            background-color: #00897b;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #reset-button:hover {
            background-color: #00695c;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>Game C·ªù Caro Online (5x5)</h1>
    
    <div id="lobby">
        <h2>Tham gia Ph√≤ng Ch∆°i</h2>
        <input type="text" id="username-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" maxlength="15">
        <input type="text" id="room-input" placeholder="Nh·∫≠p t√™n ph√≤ng (v√≠ d·ª•: Caro1)" value="CaroRoom1">
        <button id="join-button">Tham Gia</button>
        <p id="lobby-message" style="color: red; margin-top: 10px;"></p>
    </div>

    <div id="game-container" style="display: none;"> 
        <div id="player-info"></div>
        <div id="status"></div>
        
        <div id="board">
            <div class="cell" data-index="0"></div><div class="cell" data-index="1"></div><div class="cell" data-index="2"></div><div class="cell" data-index="3"></div><div class="cell" data-index="4"></div>
            <div class="cell" data-index="5"></div><div class="cell" data-index="6"></div><div class="cell" data-index="7"></div><div class="cell" data-index="8"></div><div class="cell" data-index="9"></div>
            <div class="cell" data-index="10"></div><div class="cell" data-index="11"></div><div class="cell" data-index="12"></div><div class="cell" data-index="13"></div><div class="cell" data-index="14"></div>
            <div class="cell" data-index="15"></div><div class="cell" data-index="16"></div><div class="cell" data-index="17"></div><div class="cell" data-index="18"></div><div class="cell" data-index="19"></div>
            <div class="cell" data-index="20"></div><div class="cell" data-index="21"></div><div class="cell" data-index="22"></div><div class="cell" data-index="23"></div><div class="cell" data-index="24"></div>
        </div>

        <button id="reset-button">Ch∆°i L·∫°i</button>
    </div>

    <script>
        const socket = io(); 

        // DOM elements
        const lobby = document.getElementById('lobby');
        const gameContainer = document.getElementById('game-container');
        const usernameInput = document.getElementById('username-input');
        const roomInput = document.getElementById('room-input');
        const joinButton = document.getElementById('join-button');
        const lobbyMessage = document.getElementById('lobby-message');
        const cells = document.querySelectorAll('.cell');
        const statusDisplay = document.getElementById('status');
        const playerInfoDisplay = document.getElementById('player-info');
        const resetButton = document.getElementById('reset-button');

        let myRole = null; 
        let currentRoomId = null;
        let myUsername = null;

        // X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t Tham Gia
        joinButton.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const roomId = roomInput.value.trim();

            if (!username || !roomId) {
                lobbyMessage.textContent = 'Vui l√≤ng nh·∫≠p t√™n v√† t√™n ph√≤ng.';
                return;
            }

            myUsername = username;
            currentRoomId = roomId;
            lobbyMessage.textContent = 'ƒêang tham gia...';
            
            // G·ª≠i t√™n ng∆∞·ªùi d√πng v√† t√™n ph√≤ng l√™n Server
            socket.emit('joinGame', { username, roomId });
        });

        // H√†m c·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi ch∆°i
        const updatePlayerInfo = (playerX, playerO) => {
            const infoX = playerX ? playerX.username : 'Ch·ªù ƒë·ªëi th·ªß X';
            const infoO = playerO ? playerO.username : 'Ch·ªù ƒë·ªëi th·ªß O';
            
            // Hi·ªÉn th·ªã vai tr√≤ v√† t√™n ng∆∞·ªùi ch∆°i
            playerInfoDisplay.innerHTML = `B·∫°n: <b>${myUsername} (${myRole})</b> &nbsp;|&nbsp; X: ${infoX} &nbsp;|&nbsp; O: ${infoO}`;
        }

        // ------------------
        // X·ª≠ l√Ω Socket.IO Events
        // ------------------

        // NH·∫¨N VAI TR√í T·ª™ SERVER (TH√ÄNH C√îNG)
        socket.on('playerRole', ({ role, playerX, playerO }) => {
            myRole = role;
            
            // ·∫®n Lobby, hi·ªán Game
            lobby.style.display = 'none';
            gameContainer.style.display = 'flex'; // D√πng flex ƒë·ªÉ gi·ªØ layout
            
            updatePlayerInfo(playerX, playerO);
        });

        // Nh·∫≠n th√¥ng b√°o tr·∫°ng th√°i t·ª´ Server
        socket.on('status', (message) => {
            statusDisplay.textContent = message;
        });

        // Nh·∫≠n c·∫≠p nh·∫≠t b√†n c·ªù t·ª´ Server
        socket.on('updateBoard', ({ board, nextTurn, winner, draw, playerX, playerO }) => {
            // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi ch∆°i 
            updatePlayerInfo(playerX, playerO); 
            
            // C·∫≠p nh·∫≠t giao di·ªán b√†n c·ªù
            board.forEach((value, index) => {
                cells[index].textContent = value;
            });

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i l∆∞·ª£t ch∆°i
            if (winner) {
                statusDisplay.textContent = `Ng∆∞·ªùi ch∆°i ${winner} (${winner === 'X' ? playerX.username : playerO.username}) ƒë√£ th·∫Øng! üéâ`;
            } else if (draw) {
                statusDisplay.textContent = `Tr√≤ ch∆°i h√≤a! ü§ù`;
            } else {
                statusDisplay.textContent = `L∆∞·ª£t c·ªßa Ng∆∞·ªùi ch∆°i ${nextTurn}`;
            }
        });
        
        // NH·∫¨N L·ªñI T·ª™ SERVER
        socket.on('lobbyError', (message) => {
            lobbyMessage.textContent = message;
        });

        // X·ª≠ l√Ω click (G·ª≠i n∆∞·ªõc ƒëi l√™n Server)
        const handleCellClick = (event) => {
            // Ki·ªÉm tra: ƒë√£ c√≥ vai tr√≤, t√™n ph√≤ng ch∆∞a
            if (!myRole || !currentRoomId) return; 
            
            const clickedCellIndex = parseInt(event.target.getAttribute('data-index'));

            socket.emit('makeMove', { 
                index: clickedCellIndex, 
                role: myRole, 
                roomId: currentRoomId 
            });
        };

        // X·ª≠ l√Ω n√∫t Ch∆°i L·∫°i
        resetButton.addEventListener('click', () => {
             if (currentRoomId) {
                socket.emit('resetGame', currentRoomId); 
             }
        });

        // Thi·∫øt l·∫≠p l·∫Øng nghe s·ª± ki·ªán click tr√™n c√°c √¥
        cells.forEach(cell => cell.addEventListener('click', handleCellClick));

    </script>
</body>
</html>
